---
title: 验证码
date: 2019-12-21 20:37:52
tags: JavaWeb
---

## 二维码

### 目录结构

![QvfPqf.png](https://s2.ax1x.com/2019/12/21/QvfPqf.png)

### CheckCodeServlet.java

```java
import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@WebServlet("/CheckCodeServlet")
public class CheckCodeServlet extends HttpServlet {
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
	}

	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
			String resultTip="images/error.png";
			//获取用户输入的验证码
			String checkcodeClient = request.getParameter("checkcode");
			
			//真实的验证码值
			String checkcodeServer = (String)request.getSession().getAttribute("CKECKCODE");
			if(checkcodeServer.equals(checkcodeClient)) {
				resultTip="images/right.png";
			}
			response.setContentType("text/html; charset=UTF-8");
			PrintWriter writer = response.getWriter();//输出流
			writer.write(resultTip);
			writer.flush();
			writer.close();
		}
}
```

### img.jsp

```jsp 
<%@page import="java.awt.*"%>
<%@page import="javax.imageio.ImageIO"%>
<%@page import="java.awt.Color"%>
<%@page import="java.awt.Graphics"%>
<%@page import="java.awt.image.BufferedImage"%>
<%@page import="java.util.Random"%>
<%@ page language="java" contentType="image/jpeg; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%!
	//随机产生颜色值
	public Color getColor(){
		Random ran =new Random();
		int r=ran.nextInt(256);
		int g=ran.nextInt(256);
		int b=ran.nextInt(256);
		
		return new Color(r,g,b);
	}

	//产生随机数字
	public String getNum(){
		//1000-9999
		int ran=(int) (Math.random()*9000)+1000;
		
		return String.valueOf(ran);
	}
%>

<%
	//禁止缓存，防止验证码过期
	response.setHeader("pragma", "no-cache");
	response.setHeader("cache-control", "no-cache");
	response.setHeader("Expires", "0");
	
	//绘制验证码
	BufferedImage image=new BufferedImage(80,30,BufferedImage.TYPE_INT_RGB);
	//画笔
	Graphics graphics=image.getGraphics();
	graphics.fillRect(0, 0, 80, 30);
	//绘制干扰线条
	for(int i=0;i<60;i++){
		Random ran=new Random();
		int xBegin=ran.nextInt(80);//产生小于80的随机整数
		int yBegin=ran.nextInt(30);
		
		int xEnd=ran.nextInt(xBegin+10);
		int yEnd=ran.nextInt(yBegin+10);
		
		graphics.setColor(getColor()) ;
		//绘制线条
		graphics.drawLine(xBegin, yBegin, xEnd, yEnd);
	}
	
	graphics.setFont(new Font("seif",Font.BOLD,20));
	//绘制验证码
	graphics.setColor(Color.BLACK);
	String checkCode=getNum();
	StringBuffer sb=new StringBuffer();
	for(int i=0;i<checkCode.length();i++){
		sb.append(checkCode.charAt(i)+" ");//验证码的每一位数字
	}
	
	//绘制验证码
	graphics.drawString(sb.toString(), 15, 20);
	
	//将验证码真实值保存在session中，供使用时比较真实性
	session.setAttribute("CKECKCODE", checkCode);
	
	//真实的产生图片
	ImageIO.write(image,"jpeg",response.getOutputStream());
	
	//关闭
	out.clear();
	out=pageContext.pushBody();
%>
```

### index.jsp

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style type="text/css">
 #checkcodeId{
 	height:20px;
 	width:100px;
}
</style>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" >
	$(document).ready(function(){
		$("#checkcodeId").blur(function(){
			var $checkcode =$("#checkcodeId").val();
			if($checkcode==""){
				alert("请输入验证码！")
			}else{
				//校验，输入的值发送到服务端
				//服务端将获取的值和真实值对比
				$.post(
						"CheckCodeServlet",//服务端地址
						"checkcode="+$checkcode,//验证码的值
						function(result){
							//alert(data);
							var resultHtml= $("<img src='"+result+"' height='25px' width='25px' id='isRight' />");
							$("#tip").html(resultHtml);
						}
				);
			}
		})
	});
	
	function reloadCheckImg(){
		$("#imgEWM").attr("src","img.jsp?t="+(new Date().getTime()));
		$("#isRight").css("visibility","hidden");
		$("#checkcodeId").val("");
	}

</script>

<title>验证码</title>
</head>
<body>
		<a href="javascript:reloadCheckImg()">
			<img src="img.jsp" id="imgEWM"/>点我刷新
		</a>
		</br></br>
		验证码：
		<input type="text" name="checkcode" id="checkcodeId" maxlength="4" placeholder="请输入验证码" />
		<!-- 获得验证码图片 -->
		<span id="tip"></span>
		
</body>
</html>
```

### 效果图

![QvfBdO.png](https://s2.ax1x.com/2019/12/21/QvfBdO.png)

